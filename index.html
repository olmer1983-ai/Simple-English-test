<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="./vite.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Платформа для тестов</title>
    <link rel="manifest" href="./manifest.json" />
    <meta name="theme-color" content="#ffffff" />
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Зависимости в UMD формате -->
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-router@6/umd/react-router.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-router-dom@6/umd/react-router-dom.development.js" crossorigin></script>
    <!-- Babel для компиляции JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<script type="importmap">
{
  "imports": {
    "react": "https://aistudiocdn.com/react@^19.2.0",
    "react-dom/": "https://aistudiocdn.com/react-dom@^19.2.0/",
    "react-router-dom": "https://aistudiocdn.com/react-router-dom@^7.9.6",
    "react/": "https://aistudiocdn.com/react@^19.2.0/"
  }
}
</script>
</head>
  <body class="bg-slate-50">
    <div id="root"></div>
    
    <!-- Весь код приложения объединен в один скрипт -->
    <script type="text/babel">
      const { useState, useEffect, createContext, useContext, StrictMode } = React;
      const { createRoot } = ReactDOM;
      const { HashRouter, Routes, Route, Navigate, Link, useNavigate, useParams } = ReactRouterDOM;

      // --- hooks/useLocalStorage.ts ---
      function getValue(key, initialValue) {
        const savedValue = localStorage.getItem(key);
        if (savedValue !== null) {
          try {
            return JSON.parse(savedValue);
          } catch (error) {
            console.error(`Error parsing JSON from localStorage key "${key}":`, error);
            localStorage.removeItem(key);
          }
        }
        if (initialValue instanceof Function) {
          return initialValue();
        }
        return initialValue;
      }

      function useLocalStorage(key, initialValue) {
        const [value, setValue] = useState(() => getValue(key, initialValue));
        useEffect(() => {
          localStorage.setItem(key, JSON.stringify(value));
        }, [key, value]);
        return [value, setValue];
      }

      // --- contexts/AuthContext.tsx ---
      const AuthContext = createContext(undefined);

      const AuthProvider = ({ children }) => {
        const [user, setUser] = useLocalStorage('currentUser', null);
        const login = (userData) => setUser(userData);
        const logout = () => setUser(null);
        return (
          <AuthContext.Provider value={{ user, login, logout }}>
            {children}
          </AuthContext.Provider>
        );
      };

      const useAuth = () => {
        const context = useContext(AuthContext);
        if (context === undefined) {
          throw new Error('useAuth must be used within an AuthProvider');
        }
        return context;
      };
      
      // --- components/Icons.tsx ---
      const PlusIcon = ({ className = 'w-6 h-6' }) => (
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className={className}>
          <path strokeLinecap="round" strokeLinejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
        </svg>
      );

      const TrashIcon = ({ className = 'w-6 h-6' }) => (
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className={className}>
          <path strokeLinecap="round" strokeLinejoin="round" d="m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 0 1 3.478-.397m7.5 0v-.916c0-1.18-.91-2.124-2.09-2.201a51.964 51.964 0 0 0-3.32 0c-1.18.077-2.09.921-2.09 2.201v.916m7.5 0a48.667 48.667 0 0 0-7.5 0" />
        </svg>
      );

      // --- components/LoginScreen.tsx ---
      const LoginScreen = () => {
        const [fullName, setFullName] = useState('');
        const [role, setRole] = useState('student');
        const { login } = useAuth();
        const [users, setUsers] = useLocalStorage('users', []);

        const handleSubmit = (e) => {
          e.preventDefault();
          if (!fullName.trim()) {
            alert('Пожалуйста, введите ваше полное имя.');
            return;
          }
          let user = users.find(u => u.fullName.toLowerCase() === fullName.toLowerCase() && u.role === role);
          if (!user) {
            user = { id: crypto.randomUUID(), fullName, role };
            setUsers([...users, user]);
          }
          login(user);
        };

        return (
          <div className="min-h-screen flex items-center justify-center bg-gradient-to-br from-sky-100 to-indigo-200">
            <div className="w-full max-w-md p-8 space-y-8 bg-white rounded-2xl shadow-2xl">
              <div>
                <h2 className="text-3xl font-extrabold text-center text-gray-900">
                  Платформа для тестов по английскому языку
                </h2>
                <p className="mt-2 text-center text-sm text-gray-600">
                  Войдите или зарегистрируйтесь, чтобы продолжить
                </p>
              </div>
              <form className="mt-8 space-y-6" onSubmit={handleSubmit}>
                <div className="rounded-md shadow-sm -space-y-px">
                  <div>
                    <label htmlFor="full-name" className="sr-only">Полное имя</label>
                    <input id="full-name" name="fullName" type="text" required className="appearance-none rounded-none relative block w-full px-3 py-3 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-t-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 focus:z-10 sm:text-sm" placeholder="Полное имя (например, Иван Иванов)" value={fullName} onChange={(e) => setFullName(e.target.value)} />
                  </div>
                </div>
                <div className="flex items-center justify-around">
                  <div className="flex items-center">
                    <input id="role-student" name="role" type="radio" className="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300" checked={role === 'student'} onChange={() => setRole('student')} />
                    <label htmlFor="role-student" className="ml-2 block text-sm text-gray-900">Я ученик</label>
                  </div>
                  <div className="flex items-center">
                    <input id="role-teacher" name="role" type="radio" className="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300" checked={role === 'teacher'} onChange={() => setRole('teacher')} />
                    <label htmlFor="role-teacher" className="ml-2 block text-sm text-gray-900">Я учитель</label>
                  </div>
                </div>
                <div>
                  <button type="submit" className="group relative w-full flex justify-center py-3 px-4 border border-transparent text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-colors">
                    Войти / Зарегистрироваться
                  </button>
                </div>
              </form>
            </div>
          </div>
        );
      };

      // --- components/TeacherDashboard.tsx ---
      const TeacherDashboard = () => {
        const { user, logout } = useAuth();
        const navigate = useNavigate();
        const [tests, setTests] = useLocalStorage('tests', []);

        const teacherTests = tests.filter(test => test.teacherId === user?.id);

        const deleteTest = (testId) => {
          if (window.confirm('Вы уверены, что хотите удалить этот тест? Это действие нельзя отменить.')) {
              setTests(tests.filter(t => t.id !== testId));
          }
        }
        
        const getQuestionWord = (count) => {
          const lastDigit = count % 10;
          const lastTwoDigits = count % 100;
          if (lastTwoDigits >= 11 && lastTwoDigits <= 19) return 'вопросов';
          if (lastDigit === 1) return 'вопрос';
          if ([2, 3, 4].includes(lastDigit)) return 'вопроса';
          return 'вопросов';
        };

        return (
          <div className="container mx-auto p-4 md:p-8">
            <header className="flex justify-between items-center mb-8">
              <div>
                <h1 className="text-4xl font-bold text-slate-800">Панель учителя</h1>
                <p className="text-slate-600">Добро пожаловать, {user?.fullName}</p>
              </div>
              <button onClick={logout} className="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg transition-colors">Выйти</button>
            </header>
            <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
              <Link to="/create-test" className="block p-6 bg-green-500 text-white rounded-xl shadow-lg hover:bg-green-600 transition-transform hover:scale-105">
                  <h2 className="text-2xl font-bold">Создать новый тест</h2>
                  <p>Создайте новый тест с вопросами и ответами.</p>
              </Link>
              <Link to="/results" className="block p-6 bg-sky-500 text-white rounded-xl shadow-lg hover:bg-sky-600 transition-transform hover:scale-105">
                  <h2 className="text-2xl font-bold">Результаты учеников</h2>
                  <p>Проверьте успеваемость ваших учеников.</p>
              </Link>
            </div>
            <div>
              <h2 className="text-3xl font-bold text-slate-700 mb-4">Мои тесты</h2>
              {teacherTests.length > 0 ? (
                <div className="space-y-4">
                  {teacherTests.map(test => (
                    <div key={test.id} className="bg-white p-5 rounded-lg shadow-md flex justify-between items-center">
                      <div>
                          <h3 className="text-xl font-semibold text-slate-800">{test.title}</h3>
                          <p className="text-sm text-slate-500">{test.questions.length} {getQuestionWord(test.questions.length)}</p>
                      </div>
                      <div className="flex items-center gap-2">
                          <button onClick={() => navigate(`/edit-test/${test.id}`)} className="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-md transition-colors text-sm">Редактировать</button>
                          <button onClick={() => deleteTest(test.id)} className="bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-md transition-colors text-sm">Удалить</button>
                      </div>
                    </div>
                  ))}
                </div>
              ) : (
                <div className="text-center py-10 px-6 bg-white rounded-lg shadow-md">
                   <p className="text-slate-500">Вы еще не создали ни одного теста.</p>
                   <Link to="/create-test" className="mt-4 inline-block bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg transition-colors">
                      Создать свой первый тест
                   </Link>
                </div>
              )}
            </div>
          </div>
        );
      };

      // --- components/StudentDashboard.tsx ---
      const StudentDashboard = () => {
        const { user, logout } = useAuth();
        const [tests] = useLocalStorage('tests', []);
        const [results] = useLocalStorage('results', []);

        const studentResults = results.filter(r => r.studentId === user?.id);
        const completedTestIds = new Set(studentResults.map(r => r.testId));
        const availableTests = tests.filter(t => !completedTestIds.has(t.id));
        const findResultForTest = (testId) => studentResults.find(r => r.testId === testId);
        
        const getQuestionWord = (count) => {
          const lastDigit = count % 10;
          const lastTwoDigits = count % 100;
          if (lastTwoDigits >= 11 && lastTwoDigits <= 19) return 'вопросов';
          if (lastDigit === 1) return 'вопрос';
          if ([2, 3, 4].includes(lastDigit)) return 'вопроса';
          return 'вопросов';
        };

        return (
          <div className="container mx-auto p-4 md:p-8">
            <header className="flex justify-between items-center mb-8">
              <div>
                <h1 className="text-4xl font-bold text-slate-800">Панель ученика</h1>
                <p className="text-slate-600">Добро пожаловать, {user?.fullName}</p>
              </div>
              <button onClick={logout} className="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg transition-colors">Выйти</button>
            </header>
            <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
              <div>
                  <h2 className="text-3xl font-bold text-slate-700 mb-4">Доступные тесты</h2>
                  {availableTests.length > 0 ? (
                  <div className="space-y-4">
                      {availableTests.map(test => (
                      <div key={test.id} className="bg-white p-5 rounded-lg shadow-md flex justify-between items-center">
                          <div>
                              <h3 className="text-xl font-semibold text-slate-800">{test.title}</h3>
                              <p className="text-sm text-slate-500">Создал: {test.teacherName}</p>
                              <p className="text-sm text-slate-500">{test.questions.length} {getQuestionWord(test.questions.length)}</p>
                          </div>
                          <Link to={`/take-test/${test.id}`} className="bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded-md transition-colors text-sm">
                              Начать тест
                          </Link>
                      </div>
                      ))}
                  </div>
                  ) : (
                  <div className="text-center py-10 px-6 bg-white rounded-lg shadow-md">
                      <p className="text-slate-500">Нет доступных тестов. Загляните позже!</p>
                  </div>
                  )}
              </div>
              <div>
                  <h2 className="text-3xl font-bold text-slate-700 mb-4">Пройденные тесты</h2>
                   {studentResults.length > 0 ? (
                  <div className="space-y-4">
                      {tests.filter(t => completedTestIds.has(t.id)).map(test => {
                          const result = findResultForTest(test.id);
                          return (
                              <div key={test.id} className="bg-white p-5 rounded-lg shadow-md">
                                 <div className="flex justify-between items-center">
                                   <div>
                                      <h3 className="text-xl font-semibold text-slate-800">{test.title}</h3>
                                      <p className="text-sm text-slate-500">Создал: {test.teacherName}</p>
                                   </div>
                                   <div className="text-right">
                                      <p className="text-lg font-bold text-sky-600">Результат: {result?.score}/{result?.totalQuestions}</p>
                                      <p className="text-xs text-slate-400">Пройден: {new Date(result?.date ?? '').toLocaleDateString()}</p>
                                   </div>
                                 </div>
                              </div>
                          );
                      })}
                  </div>
                  ) : (
                   <div className="text-center py-10 px-6 bg-white rounded-lg shadow-md">
                      <p className="text-slate-500">Вы еще не прошли ни одного теста.</p>
                  </div>
                  )}
              </div>
            </div>
          </div>
        );
      };

      // --- components/TestCreator.tsx ---
      const TestCreator = () => {
        const { testId } = useParams();
        const navigate = useNavigate();
        const { user } = useAuth();
        const [tests, setTests] = useLocalStorage('tests', []);
        const [title, setTitle] = useState('');
        const [questions, setQuestions] = useState([]);

        useEffect(() => {
          if (testId) {
            const existingTest = tests.find(t => t.id === testId);
            if (existingTest) {
              setTitle(existingTest.title);
              setQuestions(existingTest.questions);
            }
          }
        }, [testId, tests]);

        const addQuestion = () => {
          const newQuestion = {
            id: crypto.randomUUID(), text: '',
            answers: [{ id: crypto.randomUUID(), text: '' }, { id: crypto.randomUUID(), text: '' }],
            correctAnswerId: '',
          };
          setQuestions([...questions, newQuestion]);
        };

        const updateQuestionText = (qIndex, text) => {
          const newQuestions = [...questions];
          newQuestions[qIndex].text = text;
          setQuestions(newQuestions);
        };
        
        const removeQuestion = (qIndex) => {
          setQuestions(questions.filter((_, index) => index !== qIndex));
        };
        
        const addAnswer = (qIndex) => {
          const newQuestions = [...questions];
          newQuestions[qIndex].answers.push({ id: crypto.randomUUID(), text: '' });
          setQuestions(newQuestions);
        };
        
        const updateAnswerText = (qIndex, aIndex, text) => {
          const newQuestions = [...questions];
          newQuestions[qIndex].answers[aIndex].text = text;
          setQuestions(newQuestions);
        };

        const setCorrectAnswer = (qIndex, answerId) => {
          const newQuestions = [...questions];
          newQuestions[qIndex].correctAnswerId = answerId;
          setQuestions(newQuestions);
        }

        const removeAnswer = (qIndex, aIndex) => {
          const newQuestions = [...questions];
          newQuestions[qIndex].answers = newQuestions[qIndex].answers.filter((_, index) => index !== aIndex);
          setQuestions(newQuestions);
        };

        const saveTest = () => {
          if (!title.trim()) { alert('Пожалуйста, введите название теста.'); return; }
          if (questions.length === 0) { alert('Пожалуйста, добавьте хотя бы один вопрос.'); return; }
          for (const q of questions) {
              if (!q.text.trim()) { alert('Пожалуйста, заполните тексты всех вопросов.'); return; }
              if (q.answers.length < 2) { alert(`Вопрос "${q.text || ' '}" должен иметь как минимум два варианта ответа.`); return; }
              for (const a of q.answers) { if (!a.text.trim()) { alert(`Пожалуйста, заполните тексты всех ответов для вопроса "${q.text}".`); return; } }
              if (!q.correctAnswerId) { alert(`Пожалуйста, выберите правильный ответ для вопроса "${q.text}".`); return; }
          }

          if (testId) {
              const updatedTests = tests.map(t => t.id === testId ? { ...t, title, questions } : t);
              setTests(updatedTests);
          } else {
              const newTest = {
                  id: crypto.randomUUID(), title, questions,
                  teacherId: user.id, teacherName: user.fullName,
              };
              setTests([...tests, newTest]);
          }
          navigate('/');
        }

        return (
          <div className="container mx-auto p-4 md:p-8">
              <header className="flex justify-between items-center mb-8">
                  <h1 className="text-4xl font-bold text-slate-800">{testId ? 'Редактировать тест' : 'Создать новый тест'}</h1>
                  <div>
                      <button onClick={() => navigate('/')} className="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg transition-colors mr-2">Отмена</button>
                      <button onClick={saveTest} className="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg transition-colors">Сохранить тест</button>
                  </div>
              </header>
              <div className="bg-white p-6 rounded-lg shadow-lg mb-6">
                  <label htmlFor="test-title" className="block text-sm font-medium text-gray-700">Название теста</label>
                  <input type="text" id="test-title" value={title} onChange={e => setTitle(e.target.value)} placeholder="например, Тест по английской лексике" className="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md text-sm shadow-sm placeholder-slate-400 focus:outline-none focus:border-sky-500 focus:ring-1 focus:ring-sky-500"/>
              </div>
              <div className="space-y-6">
                  {questions.map((q, qIndex) => (
                      <div key={q.id} className="bg-white p-6 rounded-lg shadow-lg">
                          <div className="flex justify-between items-start mb-4">
                              <textarea value={q.text} onChange={e => updateQuestionText(qIndex, e.target.value)} placeholder={`Вопрос ${qIndex + 1}`} className="flex-grow mr-4 w-full px-3 py-2 bg-white border border-slate-300 rounded-md text-sm shadow-sm placeholder-slate-400 focus:outline-none focus:border-sky-500 focus:ring-1 focus:ring-sky-500" rows={2}/>
                              <button onClick={() => removeQuestion(qIndex)} className="text-red-500 hover:text-red-700 p-2 rounded-full hover:bg-red-100 transition-colors"><TrashIcon /></button>
                          </div>
                          <div className="space-y-3 pl-4 border-l-2 border-slate-200">
                              <h4 className="font-semibold text-slate-600">Варианты ответа:</h4>
                              {q.answers.map((a, aIndex) => (
                                  <div key={a.id} className="flex items-center gap-3">
                                      <input type="radio" name={`correct-answer-${q.id}`} checked={q.correctAnswerId === a.id} onChange={() => setCorrectAnswer(qIndex, a.id)} className="h-5 w-5 text-green-600 focus:ring-green-500 border-gray-300" />
                                      <input type="text" value={a.text} onChange={e => updateAnswerText(qIndex, aIndex, e.target.value)} placeholder={`Ответ ${aIndex + 1}`} className="flex-grow w-full px-3 py-2 bg-white border border-slate-300 rounded-md text-sm shadow-sm placeholder-slate-400 focus:outline-none focus:border-sky-500 focus:ring-1 focus:ring-sky-500"/>
                                      {q.answers.length > 2 && (<button onClick={() => removeAnswer(qIndex, aIndex)} className="text-red-500 hover:text-red-700 p-1 rounded-full hover:bg-red-100 transition-colors"><TrashIcon className="w-4 h-4" /></button>)}
                                  </div>
                              ))}
                              <button onClick={() => addAnswer(qIndex)} className="flex items-center gap-1 text-sm text-sky-600 hover:text-sky-800 font-medium transition-colors">
                                 <PlusIcon className="w-4 h-4"/> Добавить ответ
                              </button>
                          </div>
                      </div>
                  ))}
              </div>
              <button onClick={addQuestion} className="mt-6 flex items-center gap-2 bg-sky-500 hover:bg-sky-600 text-white font-bold py-2 px-4 rounded-lg transition-colors shadow-md"><PlusIcon /> Добавить вопрос</button>
          </div>
        );
      };

      // --- components/ResultsViewer.tsx ---
      const ResultsViewer = () => {
        const navigate = useNavigate();
        const { user } = useAuth();
        const [tests] = useLocalStorage('tests', []);
        const [results] = useLocalStorage('results', []);
        const [selectedTestId, setSelectedTestId] = useState('');

        const teacherTests = tests.filter(test => test.teacherId === user?.id);
        const filteredResults = results.filter(result => result.testId === selectedTestId);

        return (
          <div className="container mx-auto p-4 md:p-8">
            <header className="flex justify-between items-center mb-8">
              <h1 className="text-4xl font-bold text-slate-800">Результаты учеников</h1>
              <button onClick={() => navigate('/')} className="bg-sky-500 hover:bg-sky-600 text-white font-bold py-2 px-4 rounded-lg transition-colors">Назад к панели</button>
            </header>
            <div className="bg-white p-6 rounded-lg shadow-lg mb-6">
              <label htmlFor="test-select" className="block text-lg font-medium text-gray-700 mb-2">Выберите тест для просмотра результатов:</label>
              <select id="test-select" value={selectedTestId} onChange={e => setSelectedTestId(e.target.value)} className="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                <option value="">-- Выберите тест --</option>
                {teacherTests.map(test => (<option key={test.id} value={test.id}>{test.title}</option>))}
              </select>
            </div>
            {selectedTestId && (
              <div className="bg-white p-6 rounded-lg shadow-lg">
                  {filteredResults.length > 0 ? (
                      <div className="overflow-x-auto">
                          <table className="min-w-full divide-y divide-gray-200">
                              <thead className="bg-gray-50">
                              <tr>
                                  <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Имя ученика</th>
                                  <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Результат</th>
                                  <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Процент</th>
                                  <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Дата прохождения</th>
                              </tr>
                              </thead>
                              <tbody className="bg-white divide-y divide-gray-200">
                              {filteredResults.sort((a,b) => b.score - a.score).map(result => (
                                  <tr key={result.id}>
                                      <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{result.studentName}</td>
                                      <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{result.score} / {result.totalQuestions}</td>
                                      <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{((result.score / result.totalQuestions) * 100).toFixed(0)}%</td>
                                      <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{new Date(result.date).toLocaleString()}</td>
                                  </tr>
                              ))}
                              </tbody>
                          </table>
                      </div>
                  ) : (<p className="text-center text-gray-500 py-4">Для этого теста еще нет результатов.</p>)}
              </div>
            )}
          </div>
        );
      };

      // --- components/TestTaker.tsx ---
      const TestTaker = () => {
          const { testId } = useParams();
          const navigate = useNavigate();
          const { user } = useAuth();
          const [tests] = useLocalStorage('tests', []);
          const [results, setResults] = useLocalStorage('results', []);
          const [test, setTest] = useState(null);
          const [currentQuestionIndex, setCurrentQuestionIndex] = useState(0);
          const [answers, setAnswers] = useState({});

          useEffect(() => {
              const foundTest = tests.find(t => t.id === testId);
              if (foundTest) setTest(foundTest);
              else navigate('/');
          }, [testId, tests, navigate]);

          const handleAnswerSelect = (questionId, answerId) => {
              setAnswers({ ...answers, [questionId]: answerId });
          };

          const nextQuestion = () => {
              if (test && currentQuestionIndex < test.questions.length - 1) {
                  setCurrentQuestionIndex(currentQuestionIndex + 1);
              }
          };

          const prevQuestion = () => {
              if (currentQuestionIndex > 0) {
                  setCurrentQuestionIndex(currentQuestionIndex - 1);
              }
          };

          const submitTest = () => {
              if (!test) return;
              if (Object.keys(answers).length !== test.questions.length) {
                  if (!window.confirm("У вас есть неотвеченные вопросы. Вы уверены, что хотите завершить тест?")) return;
              }
              let score = 0;
              test.questions.forEach(q => { if (answers[q.id] === q.correctAnswerId) score++; });
              
              const newResult = {
                  id: crypto.randomUUID(), testId: test.id, studentId: user.id,
                  studentName: user.fullName, score, totalQuestions: test.questions.length,
                  date: new Date().toISOString()
              };
              setResults([...results, newResult]);
              navigate(`/result/${newResult.id}`);
          };

          if (!test) return <div className="flex items-center justify-center h-screen"><p>Загрузка теста...</p></div>;
          const currentQuestion = test.questions[currentQuestionIndex];

          return (
              <div className="min-h-screen bg-gray-100 flex flex-col items-center justify-center p-4">
                  <div className="w-full max-w-2xl bg-white rounded-2xl shadow-xl p-8">
                      <h1 className="text-3xl font-bold text-center mb-2">{test.title}</h1>
                      <p className="text-center text-slate-500 mb-6">Вопрос {currentQuestionIndex + 1} из {test.questions.length}</p>
                      <div className="mb-8">
                          <p className="text-xl font-semibold mb-6 text-slate-800">{currentQuestion.text}</p>
                          <div className="space-y-4">
                              {currentQuestion.answers.map(answer => (
                                  <label key={answer.id} className="flex items-center p-4 border rounded-lg cursor-pointer hover:bg-sky-50 transition-colors">
                                      <input type="radio" name={`question-${currentQuestion.id}`} checked={answers[currentQuestion.id] === answer.id} onChange={() => handleAnswerSelect(currentQuestion.id, answer.id)} className="h-5 w-5 text-sky-600 focus:ring-sky-500 border-gray-300"/>
                                      <span className="ml-4 text-slate-700">{answer.text}</span>
                                  </label>
                              ))}
                          </div>
                      </div>
                      <div className="flex justify-between items-center">
                          <button onClick={prevQuestion} disabled={currentQuestionIndex === 0} className="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-6 rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed">Назад</button>
                          {currentQuestionIndex === test.questions.length - 1 ? (
                              <button onClick={submitTest} className="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-6 rounded-lg transition-colors">Завершить тест</button>
                          ) : (
                               <button onClick={nextQuestion} className="bg-sky-500 hover:bg-sky-600 text-white font-bold py-2 px-6 rounded-lg transition-colors">Далее</button>
                          )}
                      </div>
                  </div>
              </div>
          );
      };

      // --- components/TestResultScreen.tsx ---
      const TestResultScreen = () => {
          const { resultId } = useParams();
          const navigate = useNavigate();
          const [results] = useLocalStorage('results', []);
          const [tests] = useLocalStorage('tests', []);
          const [result, setResult] = useState(null);
          const [testTitle, setTestTitle] = useState('');

          useEffect(() => {
              const foundResult = results.find(r => r.id === resultId);
              if (foundResult) {
                  setResult(foundResult);
                  const foundTest = tests.find(t => t.id === foundResult.testId);
                  if (foundTest) setTestTitle(foundTest.title);
              } else {
                  navigate('/');
              }
          }, [resultId, results, tests, navigate]);
          
          if (!result) return <div>Загрузка результатов...</div>;

          const percentage = ((result.score / result.totalQuestions) * 100).toFixed(0);

          return (
              <div className="min-h-screen bg-gradient-to-br from-green-100 to-cyan-200 flex items-center justify-center p-4">
                  <div className="w-full max-w-md text-center bg-white rounded-2xl shadow-2xl p-8">
                      <h1 className="text-2xl font-bold text-slate-800 mb-2">Тест завершен!</h1>
                      <p className="text-slate-600 mb-6">Вот ваши результаты по тесту "{testTitle}".</p>
                      <div className="my-8">
                           <p className="text-6xl font-extrabold text-sky-600">{percentage}%</p>
                           <p className="text-xl font-semibold text-slate-700 mt-2">Ваш результат {result.score} из {result.totalQuestions}</p>
                      </div>
                      <button onClick={() => navigate('/')} className="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg transition-colors">Назад к панели</button>
                  </div>
              </div>
          );
      };

      // --- App.tsx ---
      const Main = () => {
        const { user } = useAuth();
        if (!user) return <LoginScreen />;
        return (
          <div className="min-h-screen bg-slate-100 text-slate-800">
            {user.role === 'teacher' ? <TeacherRoutes /> : <StudentRoutes />}
          </div>
        );
      };

      const TeacherRoutes = () => (
        <Routes>
          <Route path="/" element={<TeacherDashboard />} />
          <Route path="/create-test" element={<TestCreator />} />
          <Route path="/edit-test/:testId" element={<TestCreator />} />
          <Route path="/results" element={<ResultsViewer />} />
          <Route path="*" element={<Navigate to="/" />} />
        </Routes>
      );

      const StudentRoutes = () => (
        <Routes>
          <Route path="/" element={<StudentDashboard />} />
          <Route path="/take-test/:testId" element={<TestTaker />} />
          <Route path="/result/:resultId" element={<TestResultScreen />} />
          <Route path="*" element={<Navigate to="/" />} />
        </Routes>
      );
      
      const App = () => (
        <AuthProvider>
          <Main />
        </AuthProvider>
      );
      
      // --- index.tsx ---
      const rootElement = document.getElementById('root');
      const root = createRoot(rootElement);
      root.render(
        <StrictMode>
          <HashRouter>
            <App />
          </HashRouter>
        </StrictMode>
      );

    </script>
    
    <script>
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('./sw.js').then(registration => {
            console.log('Service Worker зарегистрирован:', registration);
          }).catch(registrationError => {
            console.log('Ошибка регистрации Service Worker:', registrationError);
          });
        });
      }
    </script>
  </body>
</html>
